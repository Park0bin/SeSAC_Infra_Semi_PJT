---
# roles/db/tasks/schema.yaml
# ì»¨íŠ¸ë¡¤ëŸ¬ì˜ files/schema_v*.sql íŒŒì¼ ì¤‘ mysql_schema_versionì— ë§ëŠ” ê²ƒì„ ë§ˆìŠ¤í„° DBì— ì ìš©

- name: Apply schema (non-blocking)
  block:
    # 1) ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ schema íŒŒì¼ ì°¾ê¸°
    - name: Find schema files on controller
      ansible.builtin.find:
        paths: "{{ role_path }}/files"
        patterns: "schema_v*.sql"
        file_type: file
      register: schema_files
      delegate_to: localhost
      run_once: true
      become: false

    # 2) íŒŒì¼ ì—†ìœ¼ë©´ ìŠ¤í‚µ
    - name: Skip - no schema files found
      ansible.builtin.debug:
        msg: "âš ï¸ schema_v*.sql íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ìŠ¤í‚µ"
      when: schema_files.files | length == 0

    # 3) íŒŒì¼ ìˆìœ¼ë©´ ì²˜ë¦¬
    - name: Process schema files
      when: schema_files.files | length > 0
      block:
        # íŒŒì¼ëª…ì—ì„œ ë²„ì „ ì¶”ì¶œ (schema_v1.0.0.sql â†’ 1.0.0)
        - name: Extract versions from filenames
          ansible.builtin.set_fact:
            available_versions: >-
              {{
                schema_files.files
                | map(attribute='path')
                | map('basename')
                | select('match', '^schema_v[0-9]')
                | map('replace', 'schema_v', '')
                | map('replace', '.sql', '')
                | list
              }}
          run_once: true

        # ë””ë²„ê·¸: ì¶”ì¶œëœ ë²„ì „ í™•ì¸
        - name: Debug extracted versions
          ansible.builtin.debug:
            msg:
              - "ë°œê²¬í•œ íŒŒì¼ë“¤: {{ schema_files.files | map(attribute='path') | map('basename') | list }}"
              - "ì¶”ì¶œëœ ë²„ì „ë“¤: {{ available_versions }}"
          run_once: true

        # latestë©´ ë²„ì „ ì •ë ¬í•´ì„œ ìµœì‹  ì„ íƒ, ì•„ë‹ˆë©´ ì§€ì • ë²„ì „ ì‚¬ìš©
        - name: Determine target version
          ansible.builtin.set_fact:
            target_version: >-
              {{
                (
                  available_versions
                  | map('split', '.')
                  | map('map', 'int')
                  | list
                  | sort
                  | last
                  | join('.')
                )
                if ((mysql_schema_version | lower) == 'latest' and (available_versions | length) > 0)
                else (mysql_schema_version | regex_replace('^v', ''))
              }}
          run_once: true

        # ëŒ€ìƒ íŒŒì¼ëª… ìƒì„±
        - name: Set target schema filename
          ansible.builtin.set_fact:
            target_schema_file: "schema_v{{ target_version }}.sql"
          run_once: true

        # íŒŒì¼ ì¡´ì¬ í™•ì¸
        - name: Check if target file exists
          ansible.builtin.set_fact:
            schema_exists: >-
              {{
                target_schema_file in (schema_files.files | map(attribute='path') | map('basename') | list)
              }}
          run_once: true

        # íŒŒì¼ ì—†ìœ¼ë©´ ê²½ê³ 
        - name: Warn if target schema not found
          ansible.builtin.debug:
            msg:
              - "âš ï¸ ëŒ€ìƒ ìŠ¤í‚¤ë§ˆ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
              - "ìš”ì²­ ë²„ì „: {{ mysql_schema_version }}"
              - "ì°¾ëŠ” íŒŒì¼: {{ target_schema_file }}"
              - "ì‚¬ìš© ê°€ëŠ¥í•œ ë²„ì „: {{ available_versions }}"
          when: not (schema_exists | bool)

        # ë§ˆìŠ¤í„°ì— ìŠ¤í‚¤ë§ˆ ë³µì‚¬
        - name: Copy schema to master
          ansible.builtin.copy:
            src: "{{ target_schema_file }}"
            dest: "/tmp/{{ target_schema_file }}"
            mode: "0644"
          when:
            - inventory_hostname in groups['db_master']
            - schema_exists | bool

        # ë§ˆìŠ¤í„°ì— ìŠ¤í‚¤ë§ˆ ì ìš© (ì‹¤íŒ¨í•´ë„ ê³„ì†)
        - name: Import schema on master (continue on failure)
          community.mysql.mysql_db:
            name: "{{ mysql_schema_database | default(mysql_databases[0].name) }}"
            state: import
            target: "/tmp/{{ target_schema_file }}"
            login_unix_socket: /var/lib/mysql/mysql.sock
          register: import_result
          when:
            - inventory_hostname in groups['db_master']
            - schema_exists | bool
          failed_when: false

        # ê²°ê³¼ ì¶œë ¥
        - name: Report schema import result
          ansible.builtin.debug:
            msg:
              - "ğŸ“‹ ìŠ¤í‚¤ë§ˆ ì ìš© {{ 'ì„±ê³µ' if not (import_result.failed | default(false)) else 'ì‹¤íŒ¨ (ê³„ì† ì§„í–‰)' }}"
              - "ë²„ì „: {{ target_version }}"
              - "íŒŒì¼: {{ target_schema_file }}"
              - "DB: {{ mysql_schema_database | default(mysql_databases[0].name) }}"
              - "{{ import_result.msg | default('') }}"
          when:
            - inventory_hostname in groups['db_master']
            - import_result is defined

  rescue:
    - name: Report exception (continue)
      ansible.builtin.debug:
        msg: "âš ï¸ ìŠ¤í‚¤ë§ˆ ì ìš© ì¤‘ ì˜ˆì™¸ ë°œìƒ. ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤."

  when:
    - mysql_use_schema | default(false) | bool
    - mysql_schema_version is defined
    - (mysql_databases | default([])) | length > 0


- name: Display databases
  block:
    - name: Get database list
      community.mysql.mysql_query:
        login_unix_socket: /var/lib/mysql/mysql.sock
        query: SHOW DATABASES
      register: db_list

    - name: Show created databases
      ansible.builtin.debug:
        msg: "ğŸ“Š ë°ì´í„°ë² ì´ìŠ¤: {{ db_list.query_result[0] | map(attribute='Database') | list }}"
