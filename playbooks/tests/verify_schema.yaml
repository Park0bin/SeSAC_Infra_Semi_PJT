---
# verify_schema.yaml
# DB ìŠ¤í‚¤ë§ˆê°€ ì œëŒ€ë¡œ ì ìš©ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ëŠ” í”Œë ˆì´ë¶

- name: Verify database schema
  hosts: db_master
  become: true
  gather_facts: false

  vars:
    target_db: "{{ mysql_databases[0].name }}"

  tasks:
  - name: Check if database exists
    community.mysql.mysql_query:
      login_unix_socket: /var/lib/mysql/mysql.sock
      query: "SHOW DATABASES LIKE '{{ target_db }}'"
    register: db_check

  - name: Report database status
    ansible.builtin.debug:
      msg: "{{ 'âœ… ë°ì´í„°ë² ì´ìŠ¤ ì¡´ìž¬í•¨' if (db_check.rowcount[0] | int) > 0 else 'âŒ ë°ì´í„°ë² ì´ìŠ¤ ì—†ìŒ' }}: {{ target_db }}"

  - name: Get table list
    community.mysql.mysql_query:
      login_unix_socket: /var/lib/mysql/mysql.sock
      login_db: "{{ target_db }}"
      query: "SHOW TABLES"
    register: tables
    when: (db_check.rowcount[0] | int) > 0

  - name: Display tables
    ansible.builtin.debug:
      msg: "ðŸ“‹ í…Œì´ë¸” ëª©ë¡ ({{ tables.rowcount[0] }}ê°œ): {{ tables.query_result[0] | map(attribute='Tables_in_' ~ target_db) | list }}"
    when:
    - (db_check.rowcount[0] | int) > 0
    - tables.rowcount[0] | int > 0

  - name: No tables found
    ansible.builtin.debug:
      msg: "âš ï¸ í…Œì´ë¸”ì´ ì—†ìŠµë‹ˆë‹¤"
    when:
    - (db_check.rowcount[0] | int) > 0
    - tables.rowcount[0] | int == 0

  - name: Get table structures
    community.mysql.mysql_query:
      login_unix_socket: /var/lib/mysql/mysql.sock
      login_db: "{{ target_db }}"
      query: "DESCRIBE {{ item }}"
    loop: "{{ tables.query_result[0] | map(attribute='Tables_in_' ~ target_db) | list }}"
    register: table_structures
    when:
    - (db_check.rowcount[0] | int) > 0
    - tables.rowcount[0] | int > 0

  - name: Display table structures
    ansible.builtin.debug:
      msg:
      - "ðŸ“Š í…Œì´ë¸”: {{ item.item }}"
      - "ì»¬ëŸ¼: {{ item.query_result[0] | map(attribute='Field') | list }}"
    loop: "{{ table_structures.results }}"
    when:
    - table_structures is defined
    - item.query_result is defined
    loop_control:
      label: "{{ item.item }}"

  - name: Check schema version table (if exists)
    community.mysql.mysql_query:
      login_unix_socket: /var/lib/mysql/mysql.sock
      login_db: "{{ target_db }}"
      query: "SELECT * FROM schema_version ORDER BY applied_at DESC LIMIT 5"
    register: schema_versions
    when:
    - (db_check.rowcount[0] | int) > 0
    - "'schema_version' in (tables.query_result[0] | map(attribute='Tables_in_' ~ target_db) | list)"
    failed_when: false

  - name: Display schema version history
    ansible.builtin.debug:
      msg: "ðŸ”– ìŠ¤í‚¤ë§ˆ ë²„ì „ ížˆìŠ¤í† ë¦¬: {{ schema_versions.query_result[0] }}"
    when:
    - schema_versions is defined
    - schema_versions.query_result is defined
    - schema_versions.query_result[0] | length > 0

  - name: Summary
    ansible.builtin.debug:
      msg:
      - "============================================"
      - "ðŸ“Š ìŠ¤í‚¤ë§ˆ í™•ì¸ ìš”ì•½"
      - "============================================"
      - "ë°ì´í„°ë² ì´ìŠ¤: {{ target_db }}"
      - "í…Œì´ë¸” ê°œìˆ˜: {{ tables.rowcount[0] | default(0) }}"
      - "ìƒíƒœ: {{ 'âœ… ì •ìƒ' if (tables.rowcount[0] | default(0) | int) > 0 else 'âš ï¸ í…Œì´ë¸” ì—†ìŒ' }}"
    when: (db_check.rowcount[0] | int) > 0
